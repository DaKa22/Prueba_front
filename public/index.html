<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Example of the Authorization Code flow with Spotify</title>

  <!-- CSS only -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <style type="text/css">
    #login,
    #loggedin {
      display: none;
    }

    /* .text-overflow {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      width: 500px;
    } */

    img {
      width: 100%;
    }
    body {
      background-color: #151618;
    }
    .card{
      background-color: #151618;
    }
    .text-gray{
      color: #807f84;
    }
    .spotify-icon{
      fill: #fff;
      width: 3rem;
    }
    .spotify-text{
      /* width: 5rem; */
    }
    .bg-spotify-navbar {
      background-color: #262628;
    }
    .input-spotify {
      background-color: #323235;
      color: #8c8b91;
      border: none;
    }
  </style>
</head>

<body>
  <div class="container-fluid">
    <div id="login">
      <h1>This is an example of the Authorization Code flow</h1>
      <a href="/login" class="btn btn-primary">Log in with Spotify</a>
    </div>
    <div id="loggedin">
      <div id="user-profile">
      </div>
      <div id="oauth">
        
      </div>
    </div>
  </div>

  <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
  <script>
    (function () {
      let access_token = localStorage.getItem('access_token'), error, refresh_token;
      if (access_token) {
        tokenValido()
        return
      }
      const params = getHashParams();
      error = params.error;
      access_token = params.access_token;
      refresh_token = params.refresh_token;

      if (error) {
        alert('There was an error during the authentication');
        return
      }
      if (access_token) {
        // render oauth info
        localStorage.setItem('access_token', access_token);
        tokenValido()
      } else {
        // render initial screen
        $('#login').show();
        $('#loggedin').hide();
      }

      function getHashParams() {
        let hashParams = {};
        let e, r = /([^&;=]+)=?([^&;]*)/g,
          q = window.location.hash.substring(1);
        while (e = r.exec(q)) {
          hashParams[e[1]] = decodeURIComponent(e[2]);
        }
        return hashParams;
      }

      function tokenValido() {
        let access_token = localStorage.getItem('access_token')
        $.ajax({
          url: 'https://api.spotify.com/v1/me',
          headers: {
            'Authorization': 'Bearer ' + access_token
          },
          success: function (response) {
            releases();
            $('#login').hide();
            $('#loggedin').show();
          },
          error: function (error) {
            localStorage.clear();
            window.location.href = '/'
          }
        });
      }

      function releases() {
        $.ajax({
          url: 'https://api.spotify.com/v1/browse/new-releases',
          headers: {
            'Authorization': 'Bearer ' + access_token
          },
          success: function ({ albums: { items } }) {
            let html = `
              <div class="row py-3 bg-spotify-navbar">
                <div class="col-2 text-white">
                  <div class="row">
                    <div class="col-6 text-end">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="spotify-icon">
                        <path d="M248 8C111.1 8 0 119.1 0 256s111.1 248 248 248 248-111.1 248-248S384.9 8 248 8zm100.7 364.9c-4.2 0-6.8-1.3-10.7-3.6-62.4-37.6-135-39.2-206.7-24.5-3.9 1-9 2.6-11.9 2.6-9.7 0-15.8-7.7-15.8-15.8 0-10.3 6.1-15.2 13.6-16.8 81.9-18.1 165.6-16.5 237 26.2 6.1 3.9 9.7 7.4 9.7 16.5s-7.1 15.4-15.2 15.4zm26.9-65.6c-5.2 0-8.7-2.3-12.3-4.2-62.5-37-155.7-51.9-238.6-29.4-4.8 1.3-7.4 2.6-11.9 2.6-10.7 0-19.4-8.7-19.4-19.4s5.2-17.8 15.5-20.7c27.8-7.8 56.2-13.6 97.8-13.6 64.9 0 127.6 16.1 177 45.5 8.1 4.8 11.3 11 11.3 19.7-.1 10.8-8.5 19.5-19.4 19.5zm31-76.2c-5.2 0-8.4-1.3-12.9-3.9-71.2-42.5-198.5-52.7-280.9-29.7-3.6 1-8.1 2.6-12.9 2.6-13.2 0-23.3-10.3-23.3-23.6 0-13.6 8.4-21.3 17.4-23.9 35.2-10.3 74.6-15.2 117.5-15.2 73 0 149.5 15.2 205.4 47.8 7.8 4.5 12.9 10.7 12.9 22.6 0 13.6-11 23.3-23.2 23.3z"/>
                      </svg>
                    </div>
                    <div class="col-6 align-self-center">
                      <h2 class="spotify-text d-inline-block">Spotify</h2>
                    </div>
                  </div>
                </div>
                <div class="col-7 px-5 align-self-center">
                  <div class="row">
                    <div class="col-5 align-self-center">
                      <input type="text" placeholder="Buscar Artista" class="form-control input-spotify" onkeyup="buscarArtista(event)" >
                    </div>
                    <div class="col-2"></div>
                    <div class="col-5 align-self-center">
                      <input type="text" placeholder="Buscar CanciÃ³n" class="form-control input-spotify" onkeyup="buscarCancion(event)" >
                    </div>
                  </div>
                </div>
                <div class="col-3"></div>
              </div>
            `;

            html += `
              <div class="container py-5">
                <div class="row">
            `;
            
            for (const iterator of items) {
              html += `
                <div class="col-3 py-2">
                  <div class="card px-2" style="width: 18rem;">
                    <img src="${iterator.images[0].url}" class="card-img-top rounded" alt="${iterator.name}">
                    <div class="card-body">
                      <h6 class="card-title text-white">${iterator.name}</h6>
                      <p class="card-text text-gray">
                        ${iterator.artists[0].name}
                      </p>
                    </div>
                  </div>
                </div>
              `;
            }

            html += `
              </div>
            </div>
            `;
            $('#oauth').html(html)
            console.log(items)
          },
          error: function (error) {
            localStorage.clear();
            window.location.href = '/'
          }
        });
      }
    })();

    function buscarCancion({ keyCode, target: { value } }) {
      if (keyCode == 13 && value) {
        console.log(value)
      }
    }

    function buscarArtista({ keyCode, target: { value } }) {
      if (keyCode == 13 && value) {
        console.log(value)
      }
    }

  </script>
</body>

</html>